!function(b){b.widget("akottr.dragtable",{options:{revert:!1,dragHandle:".table-handle",maxMovingRows:40,excludeFooter:!1,onlyHeaderThreshold:100,dragaccept:null,persistState:null,restoreState:null,exact:!0,clickDelay:10,containment:null,cursor:"move",cursorAt:!1,distance:0,tolerance:"pointer",axis:"x",beforeStart:b.noop,beforeMoving:b.noop,beforeReorganize:b.noop,beforeStop:b.noop},originalTable:{el:null,selectedHandle:null,sortOrder:null,startIndex:0,endIndex:0},sortableTable:{el:b(),selectedHandle:b(),movingRow:b()},persistState:function(){var t=this;this.originalTable.el.find("th").each(function(e){""!==this.id&&(t.originalTable.sortOrder[this.id]=e)}),b.ajax({url:this.options.persistState,data:this.originalTable.sortOrder})},_restoreState:function(e){for(var t in e)this.originalTable.startIndex=b("#"+t).closest("th").prevAll().length+1,this.originalTable.endIndex=parseInt(e[t],10)+1,this._bubbleCols()},_bubbleCols:function(){var e,t,i,o,n=this.originalTable.startIndex,l=this.originalTable.endIndex,a=this.originalTable.el.children();if(this.options.excludeFooter&&(a=a.not("tfoot")),n<l)for(e=n;e<l;e++)for(i=a.find("> tr > td:nth-child("+e+")").add(a.find("> tr > th:nth-child("+e+")")),o=a.find("> tr > td:nth-child("+(e+1)+")").add(a.find("> tr > th:nth-child("+(e+1)+")")),t=0;t<i.length;t++)s(i[t],o[t]);else for(e=n;l<e;e--)for(i=a.find("> tr > td:nth-child("+e+")").add(a.find("> tr > th:nth-child("+e+")")),o=a.find("> tr > td:nth-child("+(e-1)+")").add(a.find("> tr > th:nth-child("+(e-1)+")")),t=0;t<i.length;t++)s(i[t],o[t])},_rearrangeTableBackroundProcessing:function(){var e=this;return function(){e._bubbleCols(),e.options.beforeStop(e.originalTable),e.sortableTable.el.remove(),b("#__dragtable_disable_text_selection__").remove(),t?b(document.body).attr("onselectstart",t):b(document.body).removeAttr("onselectstart"),i?b(document.body).attr("unselectable",i):b(document.body).removeAttr("unselectable"),null!==e.options.persistState&&(b.isFunction(e.options.persistState)?e.options.persistState(e.originalTable):e.persistState())}},_rearrangeTable:function(){var e=this;return function(){e.originalTable.selectedHandle.removeClass("dragtable-handle-selected"),e.sortableTable.el.sortable("disable"),e.sortableTable.el.addClass("dragtable-disabled"),e.options.beforeReorganize(e.originalTable,e.sortableTable),e.originalTable.endIndex=e.sortableTable.movingRow.prevAll().length+1,setTimeout(e._rearrangeTableBackroundProcessing(),50)}},_generateSortable:function(e){e.cancelBubble||(e.cancelBubble=!0);for(var o=this,t=this.originalTable.el[0].attributes,n="",i=0;i<t.length;i++)t[i].nodeValue&&"id"!=t[i].nodeName&&"width"!=t[i].nodeName&&(n+=t[i].nodeName+'="'+t[i].nodeValue+'" ');var h=[],c=[],l=(this.originalTable.el.find("tr").slice(0,this.options.maxMovingRows).each(function(e,t){for(var i=this.attributes,o="",n=0;n<i.length;n++)i[n].nodeValue&&"id"!=i[n].nodeName&&(o+=" "+i[n].nodeName+'="'+i[n].nodeValue+'"');h.push(o),c.push(b(this).height())}),[]),a=0,s=o.originalTable.el.children(),r=((s=this.options.excludeFooter?s.not("tfoot"):s).find("> tr > th").each(function(e,t){var i=b(this).is(":visible")?b(this).outerWidth():0;l.push(i),a+=i}),o.options.exact&&(d=a-o.originalTable.el.outerWidth(),l[0]-=d),'<ul class="dragtable-sortable" style="position:absolute; width:'+(a+=2)+'px;">'),d=(s.find("> tr > th").each(function(e,t){var i=b(this).is(":visible")?b(this).outerWidth():0,i=(r=r+('<li style="width:'+i+'px;">')+("<table "+n+">"),s.find("> tr > th:nth-child("+(e+1)+")"));(i=1<o.options.maxMovingRows?i.add(s.find("> tr > td:nth-child("+(e+1)+")").slice(0,o.options.maxMovingRows-1)):i).each(function(e){var t=b(this).clone().wrap("<div></div>").parent().html();0===t.toLowerCase().indexOf("<th")&&(r+="<thead>"),r=r+("<tr "+h[e]+'" style="height:'+c[e])+'px;">'+t,0===t.toLowerCase().indexOf("<th")&&(r+="</thead>"),r+="</tr>"}),r+="</table></li>"}),r+="</ul>",this.sortableTable.el=this.originalTable.el.before(r).prev(),this.sortableTable.el.find("> li > table").each(function(e,t){b(this).css("width",l[e]+"px")}),this.sortableTable.selectedHandle=this.sortableTable.el.find("th .dragtable-handle-selected"),this.options.dragaccept?"li:has("+this.options.dragaccept+")":"li"),e=(this.sortableTable.el.sortable({items:d,stop:this._rearrangeTable(),revert:this.options.revert,tolerance:this.options.tolerance,containment:this.options.containment,cursor:this.options.cursor,cursorAt:this.options.cursorAt,distance:this.options.distance,axis:this.options.axis}),this.originalTable.startIndex=b(e.target).closest("th").prevAll().length+1,this.options.beforeMoving(this.originalTable,this.sortableTable),this.sortableTable.movingRow=this.sortableTable.el.find("> li:nth-child("+this.originalTable.startIndex+")"),d=b('<style id="__dragtable_disable_text_selection__" type="text/css">body { -ms-user-select:none;-moz-user-select:-moz-none;-khtml-user-select:none;-webkit-user-select:none;user-select:none; }</style>'),b(document.head).append(d),b(document.body).attr("onselectstart","return false;").attr("unselectable","on"),window.getSelection?window.getSelection().removeAllRanges():document.selection.empty(),this.sortableTable.movingRow.trigger(b.extend(b.Event(e.type),{which:1,clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,screenX:e.screenX,screenY:e.screenY})),this.sortableTable.el.find(".ui-sortable-placeholder"));!e.height()<=0&&e.css("height",this.sortableTable.el.find(".ui-sortable-helper").height()),e.html('<div class="outer" style="height:100%;"><div class="inner" style="height:100%;"></div></div>')},bindTo:{},_create:function(){this.originalTable={el:this.element,selectedHandle:b(),sortOrder:{},startIndex:0,endIndex:0},this.bindTo=this.originalTable.el.find("th"),this.options.dragaccept&&(this.bindTo=this.bindTo.filter(this.options.dragaccept)),0<this.bindTo.find(this.options.dragHandle).length&&(this.bindTo=this.bindTo.find(this.options.dragHandle)),null!==this.options.restoreState&&(b.isFunction(this.options.restoreState)?this.options.restoreState(this.originalTable):this._restoreState(this.options.restoreState));var t=this;this.bindTo.mousedown(function(e){1===e.which&&!1!==t.options.beforeStart(t.originalTable)&&(clearTimeout(this.downTimer),this.downTimer=setTimeout(function(){t.originalTable.selectedHandle=b(this),t.originalTable.selectedHandle.addClass("dragtable-handle-selected"),t._generateSortable(e)},t.options.clickDelay))}).mouseup(function(e){clearTimeout(this.downTimer)})},redraw:function(){this.destroy(),this._create()},destroy:function(){this.bindTo.unbind("mousedown"),b.Widget.prototype.destroy.apply(this,arguments)}});var t=b(document.body).attr("onselectstart"),i=b(document.body).attr("unselectable");function s(e,t){var i=e.parentNode,o=e.nextSibling===t?e:e.nextSibling;t.parentNode.insertBefore(e,t),i.insertBefore(t,o)}}(jQuery);